<div class="users-container">
  <div class="users-header">
    <h2>Gestión de Usuarios</h2>
    <button class="btn btn-primary" (click)="openCreateForm()">
      <i class="pi pi-plus"></i> Nuevo Usuario
    </button>
  </div>

  @if (currentError) {
    <div class="alert alert-error">
      <i class="pi pi-exclamation-triangle"></i>
      {{ currentError }}
    </div>
  }

  <!-- Búsqueda -->
  <div class="search-section">
    <div class="search-input-group">
      <input 
        type="text" 
        [value]="searchTerm()"
        (input)="onSearchTermChange($any($event.target).value)"
        placeholder="Buscar por número de identidad..."
        (keyup.enter)="search()"
        class="search-input">
      <button class="btn btn-secondary" (click)="search()">
        <i class="pi pi-search"></i> Buscar
      </button>
      @if (searchTerm()) {
        <button class="btn btn-link" (click)="clearSearch()">
          <i class="pi pi-times"></i> Limpiar
        </button>
      }
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="table-container">
    @if (usersState$ | async; as state) {
      @if (state.error && state.users.length === 0) {
        <div class="empty-state error-state">
          <i class="pi pi-exclamation-triangle"></i>
          <p>{{ state.error }}</p>
          <button class="btn btn-primary" (click)="loadUsers()">
            <i class="pi pi-refresh"></i> Reintentar
          </button>
        </div>
      } @else if (state.users.length === 0) {
        <div class="empty-state">
          <i class="pi pi-inbox"></i>
          <p>No se encontraron usuarios</p>
        </div>
      } @else {
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Número Identidad</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Roles</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (user of state.users; track user.appUserId) {
              <tr>
                <td>{{ user.appUserId || '-' }}</td>
                <td>{{ user.numberIdentity || '-' }}</td>
                <td>{{ user.firstName || '-' }} {{ user.secondName || '' }}</td>
                <td>{{ user.lastName || '-' }} {{ user.secondLastname || '' }}</td>
                <td>{{ user.email || '-' }}</td>
                <td>{{ user.phone || '-' }}</td>
                <td>
                  @if (user.roles && user.roles.length > 0) {
                    <span class="badge">{{ user.roles.join(', ') }}</span>
                  } @else {
                    <span>-</span>
                  }
                </td>
                <td>
                  @if (user.active !== false) {
                    <span class="badge badge-success">Activo</span>
                  } @else {
                    <span class="badge badge-danger">Inactivo</span>
                  }
                </td>
                <td class="actions">
                  <button 
                    class="btn btn-icon btn-edit" 
                    (click)="openEditForm(user)"
                    title="Editar">
                    <i class="pi pi-pencil"></i>
                  </button>
                  <button 
                    class="btn btn-icon btn-delete" 
                    (click)="deleteUser(user)"
                    title="Eliminar">
                    <i class="pi pi-trash"></i>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      }
    }
  </div>

  <!-- Modal de formulario -->
  @if (showForm()) {
    <div class="modal-overlay" (click)="closeForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ isEditing ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>
          <button class="btn btn-icon" (click)="closeForm()">
            <i class="pi pi-times"></i>
          </button>
        </div>
        <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label for="numberIdentity">Número de Identidad *</label>
              <input 
                id="numberIdentity" 
                type="text" 
                formControlName="numberIdentity" 
                class="form-control"
                [readonly]="isEditing"
                required>
            </div>

            <div class="form-group">
              <label for="email">Email</label>
              <input 
                id="email" 
                type="email" 
                formControlName="email" 
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="firstName">Primer Nombre *</label>
              <input 
                id="firstName" 
                type="text" 
                formControlName="firstName" 
                class="form-control"
                required>
            </div>

            <div class="form-group">
              <label for="secondName">Segundo Nombre</label>
              <input 
                id="secondName" 
                type="text" 
                formControlName="secondName" 
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="lastName">Primer Apellido *</label>
              <input 
                id="lastName" 
                type="text" 
                formControlName="lastName" 
                class="form-control"
                required>
            </div>

            <div class="form-group">
              <label for="secondLastname">Segundo Apellido</label>
              <input 
                id="secondLastname" 
                type="text" 
                formControlName="secondLastname" 
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="phone">Teléfono</label>
              <input 
                id="phone" 
                type="text" 
                formControlName="phone" 
                class="form-control">
            </div>

            @if (!isEditing) {
              <div class="form-group">
                <label for="accesKey">Contraseña *</label>
                <input 
                  id="accesKey" 
                  type="password" 
                  formControlName="accesKey" 
                  class="form-control"
                  required>
              </div>
            }
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeForm()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
              {{ isEditing ? 'Actualizar' : 'Crear' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>

