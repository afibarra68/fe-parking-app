<div class="billing-price-container">
  <div class="header">
    <h1>Tarifas</h1>
    <p-button label="Nueva Tarifa" icon="pi pi-plus" (onClick)="openCreateForm()" [disabled]="loading()">
    </p-button>
  </div>

  @if (!showForm()) {
  <div class="search-bar" [formGroup]="searchForm">
    <div class="search-fields">
      <div class="search-field">
        <app-select-lib formControlName="status" [options]="statusOptions()" label="Estado" [filter]="true"
          [showClear]="true" [floatLabel]="false" [appendTo]="'body'">
        </app-select-lib>
      </div>
      <div class="search-field">
        <app-select-lib formControlName="companyCompanyId" [options]="companyOptions()" label="Empresa" [filter]="false"
          [showClear]="true" [floatLabel]="false" [appendTo]="'body'">
        </app-select-lib>
      </div>
    </div>
    <div class="search-actions">
      <p-button label="Buscar" icon="pi pi-search" (onClick)="search()" [disabled]="loading()"
        styleClass="p-button-secondary">
      </p-button>
      <p-button label="Limpiar" icon="pi pi-times" (onClick)="clearSearch()" [disabled]="loading()"
        styleClass="p-button-text">
      </p-button>
    </div>
  </div>
  }

  @if (error()) {
  <p-message severity="error" [text]="error() || ''" [closable]="true" (onClose)="error.set(null)">
  </p-message>
  }

  <p-dialog [visible]="showForm()" (visibleChange)="showForm.set($event)"
    [header]="editingBillingPrice() ? 'Editar Tarifa' : 'Nueva Tarifa'" [modal]="true" [style]="{width: '700px'}"
    [closable]="true" [draggable]="false" [resizable]="false" [dismissableMask]="true" [closeOnEscape]="true"
    [contentStyle]="{overflow: 'visible', padding: '1rem'}" (onHide)="cancelForm()">
    <form [formGroup]="form" (ngSubmit)="submitForm()">
      <div class="easy-mode-section">
        <label for="easyCoverMode" class="checkbox-label">
          <p-checkbox formControlName="easyCoverMode" inputId="easyCoverMode" [binary]="true">
          </p-checkbox>
          <span>Modo Fácil</span>
        </label>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="pricePerHour">Precio por Hora *</label>
          <p-inputNumber id="pricePerHour" formControlName="pricePerHour" [min]="0" [showButtons]="false"
            [useGrouping]="true" [mode]="'decimal'" [minFractionDigits]="2" [maxFractionDigits]="2"
            placeholder="Precio por hora">
          </p-inputNumber>
          @if (form.get('pricePerHour')?.invalid && submitted()) {
          <small class="p-error">
            El precio por hora es obligatorio y debe ser mayor o igual a 0
          </small>
          }
        </div>

        <div class="form-group">
          <label for="status">Estado *</label>
          <app-select-lib formControlName="status" [options]="statusOptions()" [filter]="true" [showClear]="false"
            [floatLabel]="false" [virtualScroll]="false" [scrollHeight]="'300px'" [appendTo]="'body'">
          </app-select-lib>
          @if (form.get('status')?.invalid && submitted()) {
          <small class="p-error">El estado es obligatorio</small>
          }
        </div>
      </div>

      <div class="form-row">
        @if (form.get('easyCoverMode')?.value === true) {
        <div class="form-group">
          <label for="basicVehicleType">Tipo Básico de Vehículo *</label>
          <app-select-lib formControlName="basicVehicleType" [options]="basicVehicleTypeOptions()" [filter]="true"
            [showClear]="true" [floatLabel]="false" [virtualScroll]="false" [scrollHeight]="'300px'"
            [appendTo]="'body'">
          </app-select-lib>
          @if (form.get('basicVehicleType')?.invalid && submitted()) {
          <small class="p-error">El tipo básico de vehículo es obligatorio en modo fácil</small>
          }
        </div>
        } @else {
        <div class="form-group">
          <label for="vehicleType">Tipo de Vehículo *</label>
          <app-select-lib formControlName="vehicleType" [options]="vehicleTypeOptions()" [filter]="true"
            [showClear]="true" [floatLabel]="false" [virtualScroll]="false" [scrollHeight]="'300px'"
            [appendTo]="'body'">
          </app-select-lib>
          @if (form.get('vehicleType')?.invalid && submitted()) {
          <small class="p-error">El tipo de vehículo es obligatorio en modo completo</small>
          }
        </div>
        }
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="dateStartDisabled">Fecha de Deshabilitación</label>
          <app-calendar-lib formControlName="dateStartDisabled" [showButtonBar]="true" [floatLabel]="false">
          </app-calendar-lib>
        </div>

        <div class="form-group">
          <label for="businessServiceBusinessServiceId">Servicio de Negocio</label>
          <app-select-lib formControlName="businessServiceBusinessServiceId" [options]="businessServiceOptions()"
            [filter]="true" [showClear]="true" [floatLabel]="false" [virtualScroll]="false" [scrollHeight]="'200px'"
            [appendTo]="'body'">
          </app-select-lib>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="companyCompanyId">Empresa *</label>
          <app-select-lib formControlName="companyCompanyId" [options]="companyOptions()" [filter]="false"
            [showClear]="true" [floatLabel]="false" [virtualScroll]="false" [scrollHeight]="'300px'" [appendTo]="'body'"
            (onChange)="onCompanyChange($event)">
          </app-select-lib>
          @if (form.get('companyCompanyId')?.invalid && submitted()) {
          <small class="p-error">La empresa es obligatoria</small>
          }
        </div>
      </div>

      <div class="form-actions">
        <p-button type="submit" [label]="loading() ? 'Guardando...' : (editingBillingPrice() ? 'Actualizar' : 'Crear')"
          icon="pi pi-check" [disabled]="form.invalid || loading()" [loading]="loading()">
        </p-button>
        <p-button type="button" label="Cancelar" icon="pi pi-times" (onClick)="cancelForm()" [disabled]="loading()"
          styleClass="p-button-secondary">
        </p-button>
      </div>
    </form>
  </p-dialog>

  @if (!showForm()) {
  <div class="table-container">
    <app-spinner [loading]="loading()" size="normal" message="Cargando tarifas..." [overlay]="true">
    </app-spinner>

    @if ((tableData$ | async); as tableData) {
    <app-table-lib [cols]="cols" [dataTable]="tableData" [hasEdit]="true" [hasDelete]="true" [hasDetail]="false"
      [hasReport]="false" (onEdit)="onTableEdit($event)" (onDelete)="onTableDelete($event)"
      (pagination)="onTablePagination($event)">
    </app-table-lib>
    }
  </div>
  }
</div>