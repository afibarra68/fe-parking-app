<div class="ticket-templates-container">
  <div class="header">
    <h1>Plantillas de Tirilla</h1>
    <p-button label="Nueva Plantilla" icon="pi pi-plus" (onClick)="openCreateForm()" [disabled]="loading">
    </p-button>
  </div>

  @if (!showForm) {
  <form [formGroup]="searchForm" class="search-bar">
    <div class="search-fields">
      <div class="search-field">
        <app-select-lib formControlName="ticketType" [options]="ticketTypes" label="Tipo Tirilla" [filter]="true"
          [virtualScroll]="false" [scrollHeight]="'200px'" [appendTo]="'body'">
        </app-select-lib>
      </div>
    </div>
    <div class="search-actions">
      <p-button label="Buscar" icon="pi pi-search" (onClick)="search()" [disabled]="loading"
        styleClass="p-button-secondary">
      </p-button>
      <p-button label="Limpiar" icon="pi pi-times" (onClick)="clearSearch()" [disabled]="loading"
        styleClass="p-button-text">
      </p-button>
    </div>
  </form>
  }

  @if (error) {
  <p-message severity="error" [text]="error" [closable]="true" (onClose)="error = null">
  </p-message>
  }

  <p-dialog [(visible)]="showForm"
    [header]="editingTicketTemplate ? 'Editar Plantilla de Tirilla' : 'Nueva Plantilla de Tirilla'" [modal]="true"
    [styleClass]="'ticket-template-dialog'" [closable]="true" [draggable]="false" [resizable]="false"
    [contentStyle]="{overflow: 'auto', padding: '0'}" (onHide)="cancelForm()">
    <div class="dialog-content-wrapper">
      <form [formGroup]="form" (ngSubmit)="submitForm()" class="form-section">
        <div class="form-group">
          <app-select-lib formControlName="printerPrinterId" [options]="printerOptions" label="Impresora"
            [filter]="true" [virtualScroll]="false" [scrollHeight]="'200px'" [appendTo]="'body'"
            [disabled]="printerOptions.length === 0">
          </app-select-lib>
          @if (printerOptions.length === 0) {
          <small class="p-info">
            No hay impresoras disponibles
          </small>
          }
        </div>

        <div class="form-group">
          <app-select-lib formControlName="ticketType" [options]="ticketTypes" label="Tipo de Tirilla *" [filter]="true"
            [virtualScroll]="false" [scrollHeight]="'200px'" [appendTo]="'body'">
          </app-select-lib>
          @if (form.get('ticketType')?.invalid && form.get('ticketType')?.touched) {
          <small class="p-error">
            El tipo de tirilla es requerido
          </small>
          }
        </div>

        <div class="form-group">
          <app-select-lib formControlName="paperSize" [options]="paperSizes" label="Tamaño de Papel *" [filter]="false"
            [virtualScroll]="false" [scrollHeight]="'200px'" [appendTo]="'body'" [disabled]="true">
          </app-select-lib>
          <small class="p-info">
            El tamaño de papel se establece automáticamente según la impresora seleccionada
          </small>
          @if (form.get('paperSize')?.invalid && form.get('paperSize')?.touched) {
          <small class="p-error">
            El tamaño de papel es requerido
          </small>
          }
        </div>

        <div class="form-group">
          <label for="imageUpload">Agregar Imagen al Template</label>
          <div class="image-upload-container">
            <input type="file" id="imageUpload" accept="image/*" (change)="onImageSelected($event)" 
              class="file-input" style="display: none;">
            <div class="image-upload-controls">
              <p-button label="Seleccionar Imagen" icon="pi pi-image" 
                (onClick)="selectImageFile()" 
                styleClass="p-button-outlined" [disabled]="loading">
              </p-button>
              @if (selectedImage) {
              <div class="image-preview-container">
                <img [src]="selectedImagePreview" alt="Vista previa" class="image-preview">
                <div class="image-actions">
                  <p-button label="Insertar en Template" icon="pi pi-plus" 
                    (onClick)="insertImageIntoTemplate()" 
                    styleClass="p-button-sm" 
                    [disabled]="!imageEscPosCode || loading">
                  </p-button>
                  <p-button icon="pi pi-times" (onClick)="clearImage()" 
                    styleClass="p-button-text p-button-danger p-button-sm" 
                    [title]="'Eliminar imagen'">
                  </p-button>
                </div>
              </div>
              }
            </div>
            <small class="p-info">
              Formatos soportados: PNG, JPG, GIF. La imagen se convertirá automáticamente a formato ESC/POS.
              Máximo recomendado: 300px de ancho para impresoras de 58mm, 400px para 80mm.
            </small>
          </div>
        </div>

        <div class="form-group">
          <label for="template">Template Excel POS *</label>
          <textarea id="template" formControlName="template" rows="12" placeholder="Contenido del template Excel POS..."
            class="p-inputtext template-textarea">
          </textarea>
          @if (form.get('template')?.invalid && form.get('template')?.touched) {
          <small class="p-error">
            El template es requerido
          </small>
          }
          <small class="p-info">
            <strong>Tip:</strong> Puedes usar el botón "Insertar Imagen" después de seleccionar una imagen para agregarla al template en la posición del cursor.
          </small>
        </div>

        <div class="form-actions">
          <p-button type="submit" [label]="loading ? 'Guardando...' : (editingTicketTemplate ? 'Actualizar' : 'Crear')"
            icon="pi pi-check" [disabled]="form.invalid || loading" [loading]="loading">
          </p-button>
          <p-button type="button" label="Cancelar" icon="pi pi-times" (onClick)="cancelForm()" [disabled]="loading"
            styleClass="p-button-secondary">
          </p-button>
        </div>
      </form>

      <div class="preview-section">
        <span class="paper-size-badge">{{ getPreviewWidth() }}</span>
        <div class="preview-header">
          <h3>Vista Previa</h3>
        </div>
        <div class="ticket-preview" [attr.data-paper-size]="getPreviewWidth()">
          <div class="ticket-content" [innerHTML]="getPreviewHTML()"></div>
        </div>
        <div class="preview-info">
          <small>Esta es una vista previa con datos de ejemplo. Los códigos ESC/POS se interpretan y aplican estilos
            visuales (negrita, doble altura, alineación).</small>
        </div>
      </div>
    </div>
  </p-dialog>

  @if (!showForm) {
  <div class="table-container">
    @if ((tableData$ | async); as tableData) {
    <app-table-lib [cols]="cols" [dataTable]="tableData" [hasEdit]="true" [hasDelete]="false" [hasDetail]="false"
      [hasReport]="false" (onEdit)="onTableEdit($event)" (onDelete)="onTableDelete($event)"
      (pagination)="onTablePagination($event)">
    </app-table-lib>
    }
  </div>
  }
</div>