<div class="billing-price-container">
  <div class="header">
    <h1>Precios de Facturaci√≥n</h1>
    <p-button 
      label="Nuevo Precio" 
      icon="pi pi-plus" 
      (onClick)="openCreateForm()" 
      [disabled]="loading">
    </p-button>
  </div>

  @if (!showForm) {
  <div class="search-bar" [formGroup]="searchForm">
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input 
        type="text" 
        pInputText 
        formControlName="status"
        placeholder="Buscar por estado..."
        (keyup.enter)="search()"
      />
    </span>
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input 
        type="text" 
        pInputText 
        formControlName="coverType"
        placeholder="Buscar por tipo de cobertura..."
        (keyup.enter)="search()"
      />
    </span>
    <app-select-lib
      formControlName="companyCompanyId"
      [options]="companyOptions"
      label="Empresa"
      [filter]="false"
      [appendTo]="'body'">
    </app-select-lib>
    <div class="search-actions">
      <p-button 
        label="Buscar" 
        icon="pi pi-search" 
        (onClick)="search()" 
        [disabled]="loading"
        styleClass="p-button-secondary">
      </p-button>
      <p-button 
        label="Limpiar" 
        icon="pi pi-times" 
        (onClick)="clearSearch()" 
        [disabled]="loading"
        styleClass="p-button-text">
      </p-button>
    </div>
  </div>
  }

  @if (error) {
  <p-message 
    severity="error" 
    [text]="error"
    [closable]="true"
    (onClose)="error = null">
  </p-message>
  }

  <p-dialog 
    [(visible)]="showForm" 
    [header]="editingBillingPrice ? 'Editar Precio' : 'Nuevo Precio'"
    [modal]="true"
    [style]="{width: '700px'}"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    [dismissableMask]="true"
    [closeOnEscape]="true"
    [contentStyle]="{overflow: 'visible', padding: '1rem'}"
    (onHide)="cancelForm()">
    <form [formGroup]="form" (ngSubmit)="submitForm()">
      <div class="form-group">
        <label for="status">Estado</label>
        <input 
          id="status"
          type="text" 
          pInputText 
          formControlName="status"
        />
      </div>

      <div class="form-group">
        <label for="coverType">Tipo de Cobertura</label>
        <input 
          id="coverType"
          type="text" 
          pInputText 
          formControlName="coverType"
        />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="start">Inicio (horas) *</label>
          <p-inputNumber
            id="start"
            formControlName="start"
            [min]="1"
            [max]="5"
            [showButtons]="true"
            [useGrouping]="false"
            placeholder="1-5 horas">
          </p-inputNumber>
          @if (form.get('start')?.invalid && form.get('start')?.touched) {
          <small class="p-error">
            El rango debe estar entre 1 y 5 horas
          </small>
          }
        </div>

        <div class="form-group">
          <label for="end">Fin (horas) *</label>
          <p-inputNumber
            id="end"
            formControlName="end"
            [min]="1"
            [max]="5"
            [showButtons]="true"
            [useGrouping]="false"
            placeholder="1-5 horas">
          </p-inputNumber>
          @if (form.get('end')?.invalid && form.get('end')?.touched) {
          <small class="p-error">
            El rango debe estar entre 1 y 5 horas
          </small>
          }
        </div>
      </div>

      <div class="form-group">
        <p-checkbox
          formControlName="applyDiscount"
          inputId="applyDiscount"
          [binary]="true"
          label="Aplicar Descuento">
        </p-checkbox>
      </div>

      <div class="form-group">
        <label for="discountDiscountId">ID Descuento</label>
        <p-inputNumber
          id="discountDiscountId"
          formControlName="discountDiscountId"
          [showButtons]="true"
          [useGrouping]="false"
          placeholder="ID del descuento">
        </p-inputNumber>
      </div>

      <div class="form-group">
        <label for="mount">Monto en Efectivo</label>
        <p-inputNumber
          id="mount"
          formControlName="mount"
          [showButtons]="true"
          [useGrouping]="true"
          [min]="0"
          placeholder="Ingrese el monto">
        </p-inputNumber>
        @if (form.get('mount')?.invalid && form.get('mount')?.touched) {
        <small class="p-error">
          El monto debe ser mayor o igual a 0
        </small>
        }
      </div>

      <app-select-lib
        formControlName="companyCompanyId"
        [options]="companyOptions"
        label="Empresa"
        [filter]="false"
        [appendTo]="'body'">
      </app-select-lib>

      <div class="form-actions">
        <p-button 
          type="submit"
          [label]="loading ? 'Guardando...' : (editingBillingPrice ? 'Actualizar' : 'Crear')"
          icon="pi pi-check"
          [disabled]="form.invalid || loading"
          [loading]="loading">
        </p-button>
        <p-button 
          type="button"
          label="Cancelar" 
          icon="pi pi-times"
          (onClick)="cancelForm()" 
          [disabled]="loading"
          styleClass="p-button-secondary">
        </p-button>
      </div>
    </form>
  </p-dialog>

  @if (!showForm) {
  <div class="table-container">
    <app-spinner 
      [loading]="loading"
      size="normal"
      message="Cargando precios..."
      [overlay]="true">
    </app-spinner>
    
    @if ((tableData$ | async); as tableData) {
    <app-table-lib
      [cols]="cols"
      [dataTable]="tableData"
      [hasEdit]="true"
      [hasDelete]="false"
      [hasDetail]="false"
      [hasReport]="false"
      (onEdit)="onTableEdit($event)"
      (onDelete)="onTableDelete($event)"
      (pagination)="onTablePagination($event)">
    </app-table-lib>
    }
  </div>
  }
</div>

