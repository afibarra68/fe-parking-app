<div class="users-container">
  <div class="header">
    <h1>Usuarios</h1>
    <p-button label="Nuevo Usuario" icon="pi pi-plus" (onClick)="openCreateForm()" [disabled]="loading">
    </p-button>
  </div>

  <div class="search-bar" *ngIf="!showForm" [formGroup]="searchForm">
    <div class="search-fields">
      <div class="search-field">
        <label for="appUserId">ID Usuario</label>
        <input id="appUserId" type="number" pInputText formControlName="appUserId" placeholder="ID de usuario" />
      </div>
      <div class="search-field">
        <label for="numberIdentity">Número Identidad</label>
        <input id="numberIdentity" type="text" pInputText formControlName="numberIdentity"
          placeholder="Número de identidad" />
      </div>
      <div class="search-field">
        <label for="companyCompanyId">ID Empresa</label>
        <input id="companyCompanyId" type="number" pInputText formControlName="companyCompanyId"
          placeholder="ID de empresa" />
      </div>
    </div>
    <div class="search-actions">
      <p-button label="Buscar" icon="pi pi-search" (onClick)="search()" [disabled]="loading"
        styleClass="p-button-secondary">
      </p-button>
      <p-button label="Limpiar" icon="pi pi-times" (onClick)="clearSearch()" [disabled]="loading"
        styleClass="p-button-text">
      </p-button>
    </div>
  </div>

  <p-message *ngIf="error" severity="error" [text]="error" [closable]="true" (onClose)="error = null">
  </p-message>

  <p-dialog [(visible)]="showForm" [header]="editingUser ? 'Editar Usuario' : 'Nuevo Usuario'" [modal]="true"
    [style]="{width: '700px'}" [closable]="true" [draggable]="false" [resizable]="false" [dismissableMask]="true"
    [closeOnEscape]="true" (onHide)="cancelForm()">
    <form [formGroup]="form" (ngSubmit)="submitForm()">
      <div class="form-row">
        <div class="form-group">
          <label for="firstName">Primer Nombre *</label>
          <input id="firstName" type="text" pInputText formControlName="firstName"
            [class.ng-invalid]="form.get('firstName')?.invalid && form.get('firstName')?.touched" />
          <small class="p-error" *ngIf="form.get('firstName')?.invalid && form.get('firstName')?.touched">
            El primer nombre es requerido
          </small>
        </div>

        <div class="form-group">
          <label for="secondName">Segundo Nombre</label>
          <input id="secondName" type="text" pInputText formControlName="secondName" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="lastName">Primer Apellido *</label>
          <input id="lastName" type="text" pInputText formControlName="lastName"
            [class.ng-invalid]="form.get('lastName')?.invalid && form.get('lastName')?.touched" />
          <small class="p-error" *ngIf="form.get('lastName')?.invalid && form.get('lastName')?.touched">
            El primer apellido es requerido
          </small>
        </div>

        <div class="form-group">
          <label for="secondLastname">Segundo Apellido *</label>
          <input id="secondLastname" type="text" pInputText formControlName="secondLastname"
            [class.ng-invalid]="form.get('secondLastname')?.invalid && form.get('secondLastname')?.touched" />
          <small class="p-error" *ngIf="form.get('secondLastname')?.invalid && form.get('secondLastname')?.touched">
            El segundo apellido es requerido
          </small>
        </div>
      </div>

      <div class="form-group">
        <label for="numberIdentity">Número de Identidad *</label>
        <input id="numberIdentity" type="text" pInputText formControlName="numberIdentity"
          [class.ng-invalid]="form.get('numberIdentity')?.invalid && form.get('numberIdentity')?.touched" />
        <small class="p-error" *ngIf="form.get('numberIdentity')?.invalid && form.get('numberIdentity')?.touched">
          El número de identidad es requerido
        </small>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="companyCompanyId">ID de Compañía</label>
          <input id="companyCompanyId" type="number" pInputText formControlName="companyCompanyId" />
        </div>

        <div class="form-group">
          <label for="processorId">ID Procesador</label>
          <input id="processorId" type="text" pInputText formControlName="processorId" />
        </div>
      </div>

      <div class="form-group">
        <app-select-lib formControlName="accessCredential" [options]="accessCredentialOptions()"
          label="Credencial de Acceso" [filter]="false" [showClear]="true" [floatLabel]="false" [virtualScroll]="false"
          [scrollHeight]="'300px'" [appendTo]="'body'">
        </app-select-lib>
      </div>

      <div class="form-group">
        <app-calendar-lib formControlName="loginLimit" label="Límite de Acceso (Fecha)" [showTime]="false"
          [showButtonBar]="true">
        </app-calendar-lib>
      </div>

      <div class="form-actions">
        <p-button type="submit" [label]="loading ? 'Guardando...' : (editingUser ? 'Actualizar' : 'Crear')"
          icon="pi pi-check" [disabled]="form.invalid || loading" [loading]="loading">
        </p-button>
        <p-button type="button" label="Cancelar" icon="pi pi-times" (onClick)="cancelForm()" [disabled]="loading"
          styleClass="p-button-secondary">
        </p-button>
      </div>
    </form>
  </p-dialog>

  <div *ngIf="!showForm" class="table-container">
    <app-spinner [loading]="loading" size="normal" message="Cargando usuarios..." [overlay]="true">
    </app-spinner>

    <app-table-lib *ngIf="(tableData$ | async) as tableData" [cols]="cols" [dataTable]="tableData" [hasEdit]="true"
      [hasDelete]="true" [hasDetail]="false" [hasReport]="false" (onEdit)="onTableEdit($event)"
      (onDelete)="onTableDelete($event)" (pagination)="onTablePagination($event)">
    </app-table-lib>
  </div>
</div>
